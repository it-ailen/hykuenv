upstream CJ_external_console {
	ip_hash;
	server chaijin.external.console;
}

upstream CJ_external_app {
	ip_hash;
	server chaijin.external.app;
}

upstream CJ_internal_admin {
	ip_hash;
	server chaijin.internal.admin;
}

upstream CJ_internal_content {
	ip_hash;
	server chaijin.internal.content;
}


server {
    listen 80;
    server_name cdn.self.hyku.com;
    rewrite ^/(.*)/$ /$1 permanent;
	access_log /var/log/nginx/cdn_access.log;
	error_log /var/log/nginx/cdn_error.log;

    location /assets {
        #root /assets;
        alias /assets;
        access_log on;
    }
}

server {
	listen 80;
	server_name	console.self.hyku.com;
    rewrite ^/(.*)/$ /$1 permanent;

	#表示index的默认查找文件，可以是个列表
	add_header Access-Control-Allow-Origin * always;
	access_log /var/log/nginx/console_access.log;
	error_log /var/log/nginx/console_error.log;

	location /content {
		proxy_pass http://CJ_external_console/content;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}

	location /ugc {
		proxy_pass http://CJ_external_console/ugc;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
	
	location /accounts {
		proxy_pass http://CJ_external_console/accounts;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
	
	location /utils {
		proxy_pass http://CJ_external_console/utils;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
	
	location /duels {
		proxy_pass http://CJ_external_console/duels;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}

	location /sync {
		proxy_pass http://CJ_external_console/sync;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}

	location = / {
	    return 301 /assets/content/console/console.html;
	}

	location /assets/ {
		proxy_pass http://cdn.self.hyku.com/assets/;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		# proxy_set_header Host $http_host; # nginx 利用Header中的Host项来路由，所以此处转发到同一节点会出问题
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
}

server {
	listen 80;
	server_name	service.self.internal.hyku.com;
    rewrite ^/(.*)/$ /$1 permanent;

	#表示index的默认查找文件，可以是个列表
	add_header Access-Control-Allow-Origin * always;
	access_log /var/log/nginx/service_internal_access.log;
	error_log /var/log/nginx/service_internal_error.log;



	location /admin {
		proxy_pass http://CJ_internal_admin/admin;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
	
	
	location /content {
		proxy_pass http://CJ_internal_content/content;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
	
	
	location /sync {
		proxy_pass http://CJ_internal_content/sync;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
}


server {
	listen 80;
	server_name	api.self.hyku.com;
    rewrite ^/(.*)/$ /$1 permanent;

	#表示index的默认查找文件，可以是个列表
	add_header Access-Control-Allow-Origin * always;
	
	location /v1/xsyncs {
		proxy_pass http://CJ_external_app/xsyncs;
		add_header 'Access-Control-Allow-Origin' '*' always;

		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-NginX-Proxy true;
		proxy_set_header X-Original-URI $request_uri;
		access_log	on;
	}
}